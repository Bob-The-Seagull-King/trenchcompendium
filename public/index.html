<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
        <meta name="theme-color" content="#2a2a2a" />

        <link rel="icon" href="%PUBLIC_URL%/favicon/favicon.ico" />
        <link rel="icon" type="image/png" href="%PUBLIC_URL%/favicon/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="%PUBLIC_URL%/favicon/favicon-16x16.png" sizes="16x16" />
        <link rel="apple-touch-icon" href="%PUBLIC_URL%/favicon/apple-touch-icon.png" />

        <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />

         <link href="/static/css/main.c02abf55.css" rel="stylesheet">
         <title>Trench Companion | The officially supported Trench Crusade ressource</title>
         <meta name="description" content="The official resource for Trench Crusade" data-react-helmet="true">
         <meta property="og:description" content="The official resource for Trench Crusade" data-react-helmet="true">
         <meta property="og:title" content="Trench Companion | Trench Companion" data-react-helmet="true">
         <meta property="og:type" content="website" data-react-helmet="true">

        <!-- GTM Init -->
        <script>
            window.dataLayer = window.dataLayer || [];
            window.gtag = function(){ dataLayer.push(arguments); };

            // Initial default consent — nur einmal global
            gtag('consent', 'default', {
                ad_storage: 'denied',
                analytics_storage: 'denied',
                ad_user_data: 'denied',
                ad_personalization: 'denied'
            });

            gtag('set', 'ads_data_redaction', true);
        </script>

        <!-- Adsense helper script -->
        <script>
            (function () {
                // Lädt das AdSense-Script genau einmal und signalisiert 'adsense:loaded'
                window.__loadAdSenseOnce = function () {
                    if (window.adsenseScriptLoaded) return;

                    // Früh setzen, um Race Conditions bei schnellem mehrfachen Aufruf zu vermeiden
                    window.adsenseScriptLoaded = true;

                    var s = document.createElement('script');
                    s.async = true;
                    s.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3744837400491966";
                    s.crossOrigin = "anonymous";
                    s.onload = function () {
                        // Signal an die App/Komponenten: AdSense ist bereit
                        window.dispatchEvent(new Event('adsense:loaded'));
                    };
                    s.onerror = function () {
                        // Falls es schief geht, Freigabe zurücksetzen, damit später erneut versucht werden kann
                        window.adsenseScriptLoaded = false;
                        console.warn('AdSense script failed to load.');
                    };
                    document.head.appendChild(s);
                };

                // Prüft, ob der Nutzer bereits eine Entscheidung bestätigt hat
                window.__maybeLoadAdsenseNow = function () {
                    try {
                        var m = window.klaro && window.klaro.getManager ? window.klaro.getManager() : null;
                        if (m && m.confirmed) {
                            // Entscheidung existiert (Accept all oder gespeicherte Auswahl) -> jetzt laden
                            window.__loadAdSenseOnce();
                        }
                    } catch (e) {
                        console.warn('maybeLoadAdsenseNow error:', e);
                    }
                };
            })();
        </script>

        <!-- Klaro styles -->
        <link rel="stylesheet" href="%PUBLIC_URL%/klaro.css">
        <!-- Klaro config -->
        <script src="%PUBLIC_URL%/klaro-config.js"></script>
        <script defer src="%PUBLIC_URL%/klaro-no-css.js"></script>
        <script defer>
            window.addEventListener('DOMContentLoaded', function () {
                klaro.setup(klaroConfig);
            });
        </script>


        <script>
            // Falls Klaro erst später verfügbar ist, prüfen wir periodisch,
            // ob bereits bestätigt wurde und laden dann AdSense.
            (function waitForKlaro() {
                if (window.klaro && window.klaro.getManager) {
                    window.__maybeLoadAdsenseNow();
                } else {
                    setTimeout(waitForKlaro, 100);
                }
            })();
        </script>

        <!-- Noscript Fallback for GTM -->
        <noscript>
            <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NFVT7W7X"
                    height="0" width="0"
                    style="display:none;visibility:hidden"></iframe>
        </noscript>
    </head>

    <body class="trench-companion">
         <noscript>You need to enable JavaScript to run this app.</noscript>
         <style>#global-loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#2a2a2a;z-index:9999}.spinner{width:48px;height:48px;border:4px solid rgba(135,18,20,.5);border-top:4px solid #d01317;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}</style>
         <style>
            #global-loader {
                position: fixed;
                inset: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #2a2a2a;
                z-index: 9999;
            }

            .spinner {
                width: 48px;
                height: 48px;
                border: 4px solid rgba(135,18,20,0.5);
                border-top: 4px solid #d01317;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
         </style>
         <div id="global-loader">
            <div class="spinner"></div>
         </div>

         <div id="root"></div>
    </body>
</html>
